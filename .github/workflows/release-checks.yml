name: Release Checks

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2

      - name: Install dependencies
        uses: r-lib/actions/setup-r-deps@v2
        with:
          extra-packages: any::devtools
          needs: check

      - name: Verify tag matches DESCRIPTION
        shell: bash
        run: |
          tag="${GITHUB_REF_NAME}"
          if [[ ! "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag '$tag' does not match expected format vMAJOR.MINOR.PATCH"
            exit 1
          fi
          version=$(grep '^Version:' DESCRIPTION | awk '{print $2}')
          if [[ -z "$version" ]]; then
            echo "Version not found in DESCRIPTION"
            exit 1
          fi
          if [[ "$tag" != "v$version" ]]; then
            echo "Tag '$tag' does not match DESCRIPTION version '$version'"
            exit 1
          fi

      - name: Run tests
        run: Rscript -e 'devtools::test()'

      - name: Run devtools::check (no errors, warnings, or notes)
        run: Rscript -e 'devtools::check(error_on = "note")'

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
